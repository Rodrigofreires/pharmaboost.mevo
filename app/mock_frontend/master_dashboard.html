<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Dashboard de Otimização - Veritare.ia</title>
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .prose h1, .prose h2, .prose strong { color: #1f2937; }
        .log-line { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const productTemplates = {
            medicine: { payload: { "product_name": "Amoxicilina 875mg", "product_info": { "indicacoes": "Infecções bacterianas.", "mecanismo_acao": "Elimina a bactéria.", "posologia": "1 comprimido de 12/12h.", "contraindicacoes": "Alergia a penicilinas." } } },
            vitamin: { payload: { "product_name": "Vitamina C Redoxon®", "product_info": { "chamada_principal": "Turbine sua imunidade!", "beneficios": "Fortalece a Imunidade; Ação Antioxidante; Mais Energia.", "como_usar": "1 comprimido em água.", "tabela_nutricional": "Vit C: 1000mg, Vit D: 10mcg, Zinco: 10mg." } } },
            dermocosmetic: { payload: { "product_name": "Protetor Isdin Fusion Water FPS 50", "product_info": { "chamada_principal": "Fotoproteção para pele oleosa.", "fatos_rapidos": "Toque Seco; Base Aquosa; Não Arde os Olhos.", "diferenciais_tecnologicos": "Tecnologia Fusion Water, Safe-Eye Tech™.", "passo_a_passo": "Aplicar na pele seca antes do sol.", "descricao_sensorial": "Textura leve em gel aquoso." } } }
        };

        function DynamicForm({ formData, setFormData }) {
            const handleProductNameChange = (e) => setFormData(prev => ({ ...prev, product_name: e.target.value }));
            const handleInfoChange = (key, value) => setFormData(prev => ({ ...prev, product_info: { ...prev.product_info, [key]: value } }));
            return ( <div className="space-y-4 max-h-96 overflow-y-auto pr-4"> <div> <label className="block text-sm font-bold text-slate-700 mb-1">Nome do Produto</label> <input type="text" value={formData.product_name} onChange={handleProductNameChange} className="w-full p-2 border border-slate-300 rounded-md"/> </div> {Object.entries(formData.product_info).map(([key, value]) => ( <div key={key}> <label className="block text-sm font-bold text-slate-700 mb-1 capitalize">{key.replace(/_/g, ' ')}</label> <textarea value={value} onChange={(e) => handleInfoChange(key, e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" rows={2}/> </div> ))} </div> );
        }

        function App() {
            const [activeTab, setActiveTab] = useState('dermocosmetic');
            const [formData, setFormData] = useState(productTemplates.dermocosmetic.payload);
            const [isOptimizing, setIsOptimizing] = useState(false);
            const [log, setLog] = useState(['Aguardando início do processo...']);
            const [finalContent, setFinalContent] = useState('');
            const [finalScore, setFinalScore] = useState('--');

            const handleTabChange = (newTab) => {
                if (newTab === activeTab) return;
                setActiveTab(newTab);
                setFormData(productTemplates[newTab].payload);
                setIsOptimizing(false);
                setLog(['Aguardando início do processo...']);
                setFinalContent('');
                setFinalScore('--');
            };

            const handleOptimize = async () => {
                setLog(['Conectando ao stream de aprendizado...']);
                setFinalContent('');
                setFinalScore('--');
                setIsOptimizing(true);
                
                try {
                    const response = await fetch('http://127.0.0.1:8000/optimize-content-stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ product_type: activeTab, ...formData })
                    });
                    
                    if (!response.ok) throw new Error(`Erro de rede: ${response.status} ${response.statusText}`);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    const processBuffer = (chunk) => {
                        buffer += chunk;
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop(); 

                        for (const line of lines) {
                            if (!line.startsWith('event: ')) continue;
                            
                            const eventType = line.match(/event: (.*)/)[1];
                            const dataStr = line.match(/data: (.*)/)[1];
                            const data = JSON.parse(dataStr);
                            const addLogLine = (message) => setLog(prev => [...prev, `> ${message}`]);

                            if (eventType === 'log' || eventType === 'update' || eventType === 'error') {
                                if (data.type === 'score') addLogLine(`Score atual: ${data.value} / 100`);
                                else if (data.type === 'strategy') addLogLine(`Nova Estratégia: ${data.value}`);
                                else if (data.type === 'result') addLogLine(`Resultado: ${data.value} (Novo Score: ${data.new_score})`);
                                else addLogLine(data.message);
                            } else if (eventType === 'done') {
                                addLogLine('--- OTIMIZAÇÃO CONCLUÍDA ---');
                                
                                // >>> CORREÇÃO 1: Limpeza do conteúdo <<<
                                // Remove os backticks e a palavra "html" do início e do fim.
                                const cleanedContent = data.final_content.replace(/^```html\n?|```$/g, '');
                                
                                setFinalContent(cleanedContent);
                                setFinalScore(data.final_score);
                            }
                        }
                    };

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) { processBuffer(''); break; }
                        processBuffer(decoder.decode(value, { stream: true }));
                    }

                } catch (error) {
                    console.error("Falha ao otimizar:", error);
                    setLog(prev => [...prev, `Erro na conexão: ${error.message}`]);
                } finally {
                    setIsOptimizing(false);
                }
            };
            
            const TabButton = ({ id, label }) => ( <button onClick={() => handleTabChange(id)} className={`flex-1 px-3 py-2.5 text-sm font-bold rounded-lg transition-all ${activeTab === id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-600 hover:bg-slate-200'}`}> {label} </button> );

            return (
                <div className="min-h-screen w-full p-4 sm:p-8">
                    <header className="text-center mb-10"><h1 className="text-5xl font-extrabold text-slate-800">Master Dashboard</h1></header>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="glass-card p-6 rounded-2xl shadow-lg flex flex-col gap-6">
                            <h2 className="text-2xl font-bold text-slate-700">1. Dados do Produto</h2>
                            <div className="flex space-x-2 bg-slate-100 p-1.5 rounded-xl"> <TabButton id="medicine" label="Medicamento" /><TabButton id="vitamin" label="Vitamina" /><TabButton id="dermocosmetic" label="Dermocosmético" /> </div>
                            <DynamicForm formData={formData} setFormData={setFormData} />
                            <button onClick={handleOptimize} disabled={isOptimizing} className="w-full mt-auto bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition-all disabled:from-slate-400 disabled:cursor-not-allowed"> {isOptimizing ? 'Otimizando...' : 'Iniciar Otimização com IA'} </button>
                        </div>
                        <div className="glass-card p-6 rounded-2xl shadow-lg flex flex-col gap-6">
                            <h2 className="text-2xl font-bold text-slate-700">2. Log de Aprendizado</h2>
                            <div className="bg-slate-900 text-white font-mono text-xs rounded-lg p-4 h-64 overflow-y-auto space-y-2"> {log.map((line, i) => <p key={i} className="log-line">{line}</p>)} </div>
                             <h2 className="text-2xl font-bold text-slate-700">3. Resultado Final</h2>
                            <div className="flex gap-4 items-start">
                                <div className="text-center bg-slate-50 p-4 rounded-xl flex-shrink-0">
                                    <p className="font-semibold text-slate-600">Score Final</p>
                                    <p className="text-6xl font-extrabold text-slate-800">{finalScore}</p>
                                </div>
                                <div className="flex-grow border-t pt-4">
                                    {/* >>> CORREÇÃO 2: Remoção da altura fixa e do scroll <<< */}
                                    <div 
                                        className="prose prose-sm sm:prose-base max-w-none text-slate-800 w-full"
                                        dangerouslySetInnerHTML={{ __html: finalContent || "<p class='text-slate-400'>O conteúdo aprimorado aparecerá aqui.</p>" }}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>