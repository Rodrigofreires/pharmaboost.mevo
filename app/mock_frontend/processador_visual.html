<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEVO - Processador Visual de Conteúdo v2.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .file-label { transition: all 0.2s ease-in-out; }
        .drag-over { background-color: #e0f2fe; border-color: #0284c7; }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: translateX(120%); opacity: 0; transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-success { background-color: #ecfdf5; color: #065f46; border: 1px solid #6ee7b7; }
        .toast-error { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        .toast-info { background-color: #eff6ff; color: #1e40af; border: 1px solid #93c5fd; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="toast-container"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Processador de Conteúdo MEVO</h1>
            <p class="text-gray-600 mt-2">Otimize a criação de conteúdo para a sua loja de forma inteligente e visual.</p>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-lg space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-semibold mb-2 text-gray-700">Passo 1: Planilha de Produtos</h2>
                    <label for="spreadsheet-upload" class="file-label border-2 border-dashed rounded-lg p-4 flex flex-col items-center justify-center h-full text-center cursor-pointer" id="spreadsheet-label">
                        <div id="spreadsheet-default-content" class="flex flex-col items-center justify-center">
                            <svg class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <span class="text-gray-600 font-medium">Arraste ou clique para selecionar a planilha (.xlsx)</span>
                        </div>
                        <div id="spreadsheet-selected-content" class="hidden flex items-center gap-2 text-green-800 font-medium">
                            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span id="spreadsheet-filename" class="truncate"></span>
                        </div>
                    </label>
                    <input type="file" id="spreadsheet-upload" class="hidden" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-2 text-gray-700">Passo 2: Adicionar Bulas em PDF</h2>
                    <label for="bulas-upload" class="file-label border-2 border-dashed rounded-lg p-4 flex flex-col items-center justify-center h-full text-center cursor-pointer" id="bulas-label">
                        <div id="bulas-default-content" class="flex flex-col items-center justify-center">
                             <svg class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                            <span class="text-gray-600 font-medium">Arraste ou clique para adicionar PDFs</span>
                        </div>
                         <div id="bulas-selected-content" class="hidden flex items-center gap-2 text-green-800 font-medium">
                             <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span id="bulas-count"></span>
                        </div>
                    </label>
                    <input type="file" id="bulas-upload" class="hidden" multiple accept=".pdf,application/pdf">
                </div>
            </div>
            
            <div id="file-sku-mapping-area" class="space-y-3"></div>

            <div class="text-center pt-8">
                <button id="process-button" class="w-full md:w-auto bg-sky-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-sky-300 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center mx-auto">
                    <span id="button-text">Iniciar Processamento</span>
                    <div id="button-loader" class="loader hidden ml-3"></div>
                </button>
            </div>
        </main>
        
        <footer id="results-section" class="mt-8 bg-white p-6 md:p-8 rounded-xl shadow-lg hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Log de Processamento</h2>
                <div id="timer-display" class="text-xl font-semibold text-sky-600 bg-sky-100 px-4 py-2 rounded-lg">
                    00:00:00
                </div>
            </div>
            <div id="status-messages" class="space-y-1 text-sm font-mono max-h-80 overflow-y-auto p-4 bg-gray-900 text-white rounded-lg"></div>
        </footer>

        <div id="review-container" class="mt-10 hidden space-y-10">
            <section id="review-section">
                <div class="text-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Revisão e Aprovação</h2>
                    <p class="text-gray-500 mt-2">Ajuste e aprove o conteúdo gerado. Apenas itens aprovados irão para a planilha final.</p>
                </div>
                <div id="review-area" class="space-y-8"></div>
                <div class="mt-8 text-center">
                     <button id="finalize-button" class="w-full md:w-1/2 bg-emerald-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-emerald-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-emerald-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Finalizar e Gerar Planilha de Aprovados
                    </button>
                </div>
            </section>

            <section id="disapproved-section" class="hidden">
                 <div class="text-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Itens Reprovados</h2>
                    <p class="text-gray-500 mt-2">Tente corrigir os itens abaixo ou exporte-os para uma análise posterior.</p>
                </div>
                <div id="disapproved-area" class="space-y-8"></div>
                <div class="mt-8 text-center flex flex-col md:flex-row gap-4 justify-center">
                    <button id="reprocess-button" class="w-full md:w-auto flex-1 bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600 transition-all">
                        Tentar Corrigir Reprovados
                    </button>
                    <button id="finalize-disapproved-button" class="w-full md:w-auto flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-all">
                        Gerar Planilha de Reprovados
                    </button>
                </div>
            </section>
        </div>
    </div>

    <template id="sku-mapping-template">
        <div class="grid grid-cols-[1fr_1fr_auto] gap-4 items-center p-1">
            <div class="text-sm text-gray-800 bg-gray-100 p-2 rounded-lg truncate" data-name="fileName" title=""></div>
            <input type="number" class="sku-input w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="Digite o SKU aqui">
            <button class="delete-bula-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-full transition-colors" title="Remover Bula">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
    </template>

    <template id="review-card-template">
        <div class="p-5 border-2 rounded-xl shadow-md bg-white transition-all duration-300 space-y-6">
            <div class="flex flex-wrap justify-between items-center pb-4 border-b">
                <div class="mb-2 sm:mb-0">
                    <h3 class="font-bold text-xl text-sky-800" data-name="sku"></h3>
                    <p class="text-md text-gray-600" data-name="productName"></p>
                </div>
                <div data-name="actions" class="flex items-center space-x-3">
                    <button data-action="disapprove" class="disapprove-btn bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 font-semibold flex items-center gap-2"><span>Reprovar</span></button>
                    <button data-action="approve" class="approve-btn bg-sky-500 text-white px-5 py-2 rounded-lg hover:bg-sky-600 font-semibold flex items-center gap-2"><span>Aprovar</span></button>
                </div>
                <div data-name="statusBadge" class="hidden"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Título SEO</label>
                    <textarea rows="3" class="data-input w-full p-2 border border-gray-300 rounded-lg" data-name="seoTitle"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Meta Descrição</label>
                    <textarea rows="3" class="data-input w-full p-2 border border-gray-300 rounded-lg" data-name="metaDescription"></textarea>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Conteúdo HTML</label>
                <textarea rows="15" class="data-input w-full p-2 border border-gray-300 rounded-lg font-mono text-xs" data-name="htmlContent"></textarea>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Preview Visual</label>
                <iframe class="w-full h-full border bg-white rounded-lg" style="min-height: 500px;" data-name="previewFrame"></iframe>
            </div>
        </div>
    </template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO DA APLICAÇÃO ---
        const state = {
            spreadsheetFile: null,
            bulaFiles: [],
            fileSkuMappings: {},
            reviewItems: {},
            ui: { isProcessing: false },
            // NOVO: Estado para o cronômetro
            timer: {
                intervalId: null,
                startTime: 0
            }
        };

        // --- REFERÊNCIAS AOS ELEMENTOS DO DOM ---
        const dom = {
            spreadsheetUpload: document.getElementById('spreadsheet-upload'),
            spreadsheetLabel: document.getElementById('spreadsheet-label'),
            spreadsheetDefaultContent: document.getElementById('spreadsheet-default-content'),
            spreadsheetSelectedContent: document.getElementById('spreadsheet-selected-content'),
            spreadsheetFilename: document.getElementById('spreadsheet-filename'),
            bulasUpload: document.getElementById('bulas-upload'),
            bulasLabel: document.getElementById('bulas-label'),
            bulasDefaultContent: document.getElementById('bulas-default-content'),
            bulasSelectedContent: document.getElementById('bulas-selected-content'),
            bulasCount: document.getElementById('bulas-count'),
            fileSkuMappingArea: document.getElementById('file-sku-mapping-area'),
            processButton: document.getElementById('process-button'),
            buttonText: document.getElementById('button-text'),
            buttonLoader: document.getElementById('button-loader'),
            resultsSection: document.getElementById('results-section'),
            statusMessages: document.getElementById('status-messages'),
            reviewContainer: document.getElementById('review-container'),
            reviewArea: document.getElementById('review-area'),
            finalizeButton: document.getElementById('finalize-button'),
            disapprovedSection: document.getElementById('disapproved-section'),
            disapprovedArea: document.getElementById('disapproved-area'),
            reprocessButton: document.getElementById('reprocess-button'),
            finalizeDisapprovedButton: document.getElementById('finalize-disapproved-button'),
            toastContainer: document.getElementById('toast-container'),
            // NOVO: Referência ao display do cronômetro
            timerDisplay: document.getElementById('timer-display')
        };
        
        // --- SERVIÇO DE API ---
        const apiService = {
            baseUrl: 'http://127.0.0.1:8000',
            async streamRequest(endpoint, formData, onEvent) {
                const response = await fetch(`${this.baseUrl}${endpoint}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).detail || 'Erro no servidor');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    chunk.split('\n\n').filter(line => line.trim()).forEach(line => {
                        const event = line.match(/event: (.+)/)?.[1];
                        const data = line.match(/data: (.+)/)?.[1];
                        if (event && data) onEvent(event, JSON.parse(data));
                    });
                }
            },
            async finalize(endpoint, formData) {
                const response = await fetch(`${this.baseUrl}${endpoint}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).detail || 'Falha na finalização');
                return response.json();
            }
        };
        
        // --- MANIPULAÇÃO DA UI ---
        const ui = {
            // ... (showToast, addStatusMessage, updateBulasUI, renderBulaList, renderReviewCard, updateGlobalUI, setProcessingState - sem alterações)
            showToast(message, type = 'info') {
                const types = { success: 'toast-success', error: 'toast-error', info: 'toast-info' };
                const toast = document.createElement('div');
                toast.className = `toast ${types[type]}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 5000);
            },
            addStatusMessage(message, type = 'info') {
                const colors = { info: 'text-gray-300', success: 'text-green-400', error: 'text-red-400', warning: 'text-yellow-400' };
                const time = new Date().toLocaleTimeString();
                dom.statusMessages.innerHTML += `<p class="${colors[type]}"><span class="text-cyan-400">[${time}]</span> ${message}</p>`;
                dom.statusMessages.scrollTop = dom.statusMessages.scrollHeight;
            },
            updateBulasUI() {
                if (state.bulaFiles.length > 0) {
                    dom.bulasDefaultContent.classList.add('hidden');
                    dom.bulasSelectedContent.classList.remove('hidden');
                    dom.bulasCount.textContent = `${state.bulaFiles.length} bula(s) adicionada(s)`;
                    dom.bulasLabel.classList.add('border-green-500', 'bg-green-50');
                } else {
                    dom.bulasDefaultContent.classList.remove('hidden');
                    dom.bulasSelectedContent.classList.add('hidden');
                    dom.bulasLabel.classList.remove('border-green-500', 'bg-green-50');
                }
                this.renderBulaList();
            },
            renderBulaList() {
                dom.fileSkuMappingArea.innerHTML = '';
                if (state.bulaFiles.length === 0) return;
                const header = `<div class="grid grid-cols-[1fr_1fr_auto] gap-4 font-semibold text-gray-600 px-2 pb-2 border-b"><span>Arquivo PDF</span><span>SKU</span></div>`;
                dom.fileSkuMappingArea.innerHTML = header;
                const template = document.getElementById('sku-mapping-template');
                state.bulaFiles.forEach((file, index) => {
                    const clone = template.content.cloneNode(true);
                    const fileNameElement = clone.querySelector('[data-name="fileName"]');
                    fileNameElement.textContent = file.name;
                    fileNameElement.title = file.name; 
                    const deleteButton = clone.querySelector('.delete-bula-btn');
                    deleteButton.dataset.index = index;
                    deleteButton.addEventListener('click', handleDeleteBula);
                    dom.fileSkuMappingArea.appendChild(clone);
                });
            },
            renderReviewCard(item) {
                const sku = item.sku;
                state.reviewItems[sku] = { ...item, status: 'pending' };
                const template = document.getElementById('review-card-template');
                const card = template.content.cloneNode(true).firstElementChild;
                card.id = `card-${sku}`;
                card.querySelector('[data-name="sku"]').textContent = `SKU: ${sku}`;
                card.querySelector('[data-name="productName"]').textContent = item.product_name;
                card.querySelector('[data-name="seoTitle"]').value = item.seo_title;
                card.querySelector('[data-name="metaDescription"]').value = item.meta_description;
                const htmlContentArea = card.querySelector('[data-name="htmlContent"]');
                const previewFrame = card.querySelector('[data-name="previewFrame"]');
                htmlContentArea.value = item.html_content;
                previewFrame.srcdoc = item.html_content;
                htmlContentArea.addEventListener('input', e => previewFrame.srcdoc = e.target.value);
                card.querySelector('[data-action="approve"]').onclick = () => handleItemAction(sku, 'approved');
                card.querySelector('[data-action="disapprove"]').onclick = () => handleItemAction(sku, 'disapproved');
                dom.reviewArea.appendChild(card);
            },
            updateGlobalUI() {
                const statuses = Object.values(state.reviewItems).map(item => item.status);
                const hasPending = statuses.some(s => s === 'pending');
                const hasApproved = statuses.some(s => s === 'approved');
                const hasDisapproved = statuses.some(s => s === 'disapproved');
                dom.finalizeButton.disabled = hasPending || !hasApproved;
                dom.disapprovedSection.classList.toggle('hidden', !hasDisapproved);
                dom.reviewContainer.classList.toggle('hidden', Object.keys(state.reviewItems).length === 0);
            },
            setProcessingState(isProcessing) {
                state.ui.isProcessing = isProcessing;
                dom.processButton.disabled = isProcessing;
                dom.buttonText.textContent = isProcessing ? 'Processando...' : 'Iniciar Processamento';
                dom.buttonLoader.classList.toggle('hidden', !isProcessing);
            },

            // --- NOVAS FUNÇÕES PARA O CRONÔMETRO ---
            formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');
            },
            
            updateTimer() {
                const elapsedTime = Date.now() - state.timer.startTime;
                dom.timerDisplay.textContent = ui.formatTime(elapsedTime);
            },
            
            startTimer() {
                if (state.timer.intervalId) clearInterval(state.timer.intervalId);
                state.timer.startTime = Date.now();
                dom.timerDisplay.textContent = '00:00:00';
                state.timer.intervalId = setInterval(this.updateTimer, 1000);
            },
            
            stopTimer() {
                clearInterval(state.timer.intervalId);
                state.timer.intervalId = null;
                const totalTime = Date.now() - state.timer.startTime;
                const formattedTotalTime = this.formatTime(totalTime);
                this.addStatusMessage(`<b>Tempo total de processamento: ${formattedTotalTime}</b>`, 'success');
                dom.timerDisplay.textContent = formattedTotalTime;
            }
        };

        // --- MANIPULADORES DE EVENTOS ---
        // ... (handleFileUpload, handleDeleteBula, setupDragAndDrop - sem alterações)
        function handleFileUpload(event, fileType) {
            const files = event.target.files;
            if (fileType === 'spreadsheet') {
                state.spreadsheetFile = files[0];
                 if (state.spreadsheetFile) {
                    dom.spreadsheetDefaultContent.classList.add('hidden');
                    dom.spreadsheetSelectedContent.classList.remove('hidden');
                    dom.spreadsheetFilename.textContent = state.spreadsheetFile.name;
                    dom.spreadsheetLabel.classList.add('border-green-500', 'bg-green-50');
                } else {
                    dom.spreadsheetDefaultContent.classList.remove('hidden');
                    dom.spreadsheetSelectedContent.classList.add('hidden');
                    dom.spreadsheetLabel.classList.remove('border-green-500', 'bg-green-50');
                }
            } else {
                const newFiles = Array.from(files);
                let addedCount = 0;
                newFiles.forEach(newFile => {
                    if (!state.bulaFiles.some(existingFile => existingFile.name === newFile.name)) {
                        state.bulaFiles.push(newFile);
                        addedCount++;
                    } else {
                        ui.showToast(`O arquivo "${newFile.name}" já foi adicionado.`, 'info');
                    }
                });
                if (addedCount > 0) ui.updateBulasUI();
                event.target.value = ''; 
            }
        }
        
        function handleDeleteBula(event) {
            event.preventDefault();
            const indexToDelete = parseInt(event.currentTarget.dataset.index, 10);
            const fileName = state.bulaFiles[indexToDelete].name;
            state.bulaFiles.splice(indexToDelete, 1);
            ui.updateBulasUI();
            ui.showToast(`Arquivo "${fileName}" removido.`, 'info');
        }

        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                [dom.spreadsheetLabel, dom.bulasLabel].forEach(label => {
                    label.addEventListener(eventName, e => e.preventDefault());
                    if (['dragenter', 'dragover'].includes(eventName)) label.classList.add('drag-over');
                    if (['dragleave', 'drop'].includes(eventName)) label.classList.remove('drag-over');
                });
            });
            dom.spreadsheetLabel.addEventListener('drop', e => {
                dom.spreadsheetUpload.files = e.dataTransfer.files;
                handleFileUpload({ target: dom.spreadsheetUpload }, 'spreadsheet');
            });
            dom.bulasLabel.addEventListener('drop', e => {
                dom.bulasUpload.files = e.dataTransfer.files;
                handleFileUpload({ target: dom.bulasUpload }, 'bula');
            });
        }
        

        // --- LÓGICA PRINCIPAL ---
        async function startProcessing(isReprocessing = false, itemsToReprocess = []) {
            let filesForUpload, skusForUpload;
            if (isReprocessing) {
                // ... (lógica de reprocessamento sem alterações)
            } else {
                const skuInputs = Array.from(dom.fileSkuMappingArea.querySelectorAll('.sku-input'));
                if (!state.spreadsheetFile) return ui.showToast('Por favor, selecione a planilha de produtos.', 'error');
                if (state.bulaFiles.length === 0) return ui.showToast('Por favor, adicione pelo menos uma bula em PDF.', 'error');
                if (skuInputs.some(i => !i.value.trim())) return ui.showToast('Por favor, preencha o SKU para cada bula.', 'error');
                
                // Preparação da UI
                ui.setProcessingState(true);
                dom.resultsSection.classList.remove('hidden');
                dom.reviewContainer.classList.add('hidden');
                dom.reviewArea.innerHTML = '';
                dom.disapprovedArea.innerHTML = '';
                dom.statusMessages.innerHTML = '';
                state.reviewItems = {};
                state.fileSkuMappings = {};
                
                skuInputs.forEach((input, index) => {
                    const sku = input.value.trim();
                    if (sku) {
                        const fileName = state.bulaFiles[index].name;
                        state.fileSkuMappings[sku] = { fileIndex: index, fileName: fileName };
                    }
                });
                
                filesForUpload = state.bulaFiles;
                skusForUpload = Object.keys(state.fileSkuMappings);
            }

            // --- ALTERAÇÕES PARA O CRONÔMETRO ---
            if (!isReprocessing) {
                ui.startTimer(); // Inicia o cronômetro
            }
            
            const formData = new FormData();
            formData.append('spreadsheet', state.spreadsheetFile);
            filesForUpload.forEach(file => formData.append('bulas', file));
            formData.append('skus_json', JSON.stringify(skusForUpload));

            try {
                const onEvent = (type, data) => {
                    if (type === 'log') ui.addStatusMessage(data.message, data.type);
                    if (type === 'review_item') ui.renderReviewCard(data);
                    if (type === 'error') ui.showToast(data.message, 'error');
                };
                const endpoint = isReprocessing ? '/reprocess-items' : '/process-for-review';
                await apiService.streamRequest(endpoint, formData, onEvent);
                ui.addStatusMessage(`${isReprocessing ? 'Re' : ''}processamento concluído.`, "success");
                ui.updateGlobalUI();
            } catch (error) {
                ui.addStatusMessage(`ERRO: ${error.message}`, 'error');
                ui.showToast(error.message, 'error');
            } finally {
                if (!isReprocessing) {
                    ui.setProcessingState(false);
                    ui.stopTimer(); // Para o cronômetro e mostra o tempo total
                }
            }
        }
        
        // ... (handleItemAction, finalize, reprocessDisapproved - sem alterações)
        function handleItemAction(sku, status) {
            state.reviewItems[sku].status = status;
            const card = document.getElementById(`card-${sku}`);
            if (status === 'approved') {
                state.reviewItems[sku].seo_title = card.querySelector('[data-name="seoTitle"]').value;
                state.reviewItems[sku].meta_description = card.querySelector('[data-name="metaDescription"]').value;
                state.reviewItems[sku].html_content = card.querySelector('[data-name="htmlContent"]').value;
            }
            card.querySelector('[data-name="actions"]').classList.add('hidden');
            const statusBadge = card.querySelector('[data-name="statusBadge"]');
            statusBadge.classList.remove('hidden');
            card.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            if (status === 'approved') {
                card.classList.add('border-green-500', 'bg-green-50');
                statusBadge.innerHTML = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">Aprovado ✓</span>`;
            } else {
                card.classList.add('border-red-500', 'bg-red-50');
                statusBadge.innerHTML = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">Reprovado ✗</span>`;
                dom.disapprovedArea.appendChild(card);
            }
            ui.updateGlobalUI();
        }

        async function finalize(type) {
            const dataToFinalize = Object.values(state.reviewItems).filter(item => item.status === type);
            if (dataToFinalize.length === 0) return ui.showToast(`Nenhum item ${type === 'approved' ? 'aprovado' : 'reprovado'}.`, 'info');
            const formData = new FormData();
            formData.append('spreadsheet', state.spreadsheetFile);
            const endpoint = type === 'approved' ? '/finalize-spreadsheet' : '/finalize-disapproved-spreadsheet';
            const jsonKey = type === 'approved' ? 'approved_data_json' : 'disapproved_data_json';
            formData.append(jsonKey, JSON.stringify(dataToFinalize));
            try {
                const result = await apiService.finalize(endpoint, formData);
                ui.showToast(`Planilha gerada com sucesso!`, 'success');
                const byteCharacters = atob(result.file_data);
                const byteArray = new Uint8Array(byteCharacters.length).map((_, i) => byteCharacters.charCodeAt(i));
                const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: result.filename });
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(a.href);
                a.remove();
            } catch (error) {
                ui.showToast(error.message, 'error');
            }
        }

        function reprocessDisapproved() {
            const itemsToReprocess = Object.entries(state.reviewItems)
                .filter(([_, item]) => item.status === 'disapproved')
                .map(([sku, _]) => ({ sku, ...state.fileSkuMappings[sku] }));
            if (itemsToReprocess.length === 0) return ui.showToast('Não há itens reprovados.', 'info');
            
            // Inicia o timer para o reprocessamento também
            ui.startTimer();

            itemsToReprocess.forEach(item => {
                document.getElementById(`card-${item.sku}`)?.remove();
                delete state.reviewItems[item.sku];
            });
            // O `finally` dentro de startProcessing vai parar o timer
            startProcessing(true, itemsToReprocess);
        }
        
        // --- INICIALIZAÇÃO ---
        dom.spreadsheetUpload.addEventListener('change', e => handleFileUpload(e, 'spreadsheet'));
        dom.bulasUpload.addEventListener('change', e => handleFileUpload(e, 'bula'));
        dom.processButton.addEventListener('click', () => startProcessing(false));
        dom.finalizeButton.addEventListener('click', () => finalize('approved'));
        dom.finalizeDisapprovedButton.addEventListener('click', () => finalize('disapproved'));
        dom.reprocessButton.addEventListener('click', reprocessDisapproved);
        setupDragAndDrop();
    });
</script>
</body>
</html>